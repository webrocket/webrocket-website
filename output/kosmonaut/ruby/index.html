<!DOCTYPE HTML>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>WebRocket - Kosmonaut for Ruby</title>
    <link rel="stylesheet" type="text/css" href="/css/webfonts.css" media="screen">
    <link rel="stylesheet" type="text/css" href="/css/style.css" media="screen">
    <meta name="generator" content="nanoc 3.2.4">
  </head>
  <body>
    <header role="banner">
      <div class="vessel">
        <h1 id="logo"><a href="/">webrocket</a></h1>
        <nav role="navigation">
          <li><a href="/docs/">Docs</a></li>
          <li><a href="/guides/">Guides</a></li>
          <li><a href="/cloud/">Our Cloud!</a></li>
        </nav>
        <div class="clearfix"></div>
      </div>
    </header>
    <aside id="tagline">
      <div class="vessel">
        Distributed Web Broker for the Masses!
      </div>
    </aside>
    <section role="main">
      <div class="vessel">
        
        <div class="article">
          <h2>Kosmonaut for Ruby</h2>
          <aside id="toc"><h3>In this section</h3>
<ul>
<li><a href="#Installation">Installation</a></li>
<li><a href="#Client">Client</a></li>
<li><a href="#Worker">Worker</a></li>
<li><a href="#Troubleshooting">Troubleshooting</a></li>
</ul></aside><p>Kosmonaut version for Ruby is an <strong>official</strong> client. It is considered to be <strong>stable</strong>.</p>

<p>Ruby implementation follows <a href="/docs/kosmonaut/">the concept of Kosmonaut</a> by providing
two kind of sockets. Below you can find a trivial examples of usage both
of them.</p>

<h3 id="Installation">Installation</h3>

<p>You can install it easily via rubygems:</p>

<pre><code>$ gem install kosmonaut
</code></pre>

<p>If you are using bundler, then just add the following line:</p>

<pre><code>gem "kosmonaut", "&gt;= 0.3.0"
</code></pre>

<h3 id="Client">Client</h3>

<p>Client will be used to manage channels, provide authentication gateway and broadcast
events from the application.</p>

<p>Initialization:</p>

<pre><code class="language-ruby"><span class="n">client</span> <span class="o">=</span> <span class="no">Kosmonaut</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"wr://token...@127.0.0.1:8080/vhost"</span><span class="p">)</span></code></pre>

<p>Opening channel:</p>

<pre><code class="language-ruby"><span class="n">client</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="s2">"room"</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="s2">"presence-room"</span><span class="p">)</span>
<span class="n">client</span><span class="o">.</span><span class="n">open_channel</span><span class="p">(</span><span class="s2">"private-room"</span><span class="p">)</span></code></pre>

<p>Closing channel:</p>

<pre><code class="language-ruby"><span class="n">client</span><span class="o">.</span><span class="n">close_channel</span><span class="p">(</span><span class="s2">"room"</span><span class="p">)</span></code></pre>

<p>Broadcasting data:</p>

<pre><code class="language-ruby"><span class="n">client</span><span class="o">.</span><span class="n">broadcast</span><span class="p">(</span><span class="s2">"room"</span><span class="p">,</span> <span class="s2">"hello"</span><span class="p">,</span> <span class="p">{</span><span class="s2">"what"</span><span class="p">:</span> <span class="s2">"world"</span><span class="p">})</span></code></pre>

<p>Requesting for a single access token:</p>

<pre><code class="language-ruby"><span class="n">client</span><span class="o">.</span><span class="n">request_single_access_token</span><span class="p">(</span><span class="s2">"joe"</span><span class="p">,</span> <span class="s2">".*"</span><span class="p">)</span></code></pre>

<h3 id="Worker">Worker</h3>

<p>Worker is designed to listen and handle all messages incoming from the backend
endpoint of WebRocket server.</p>

<p>It shall be used by creating custom worker which inherits from <code>Kosmonaut::Worker</code>
and defines three handlers: <code>on_message</code>, <code>on_error</code> and <code>on_exception</code>. Here's an example:</p>

<pre><code class="language-ruby"><span class="k">class</span> <span class="nc">MyWorker</span> <span class="o">&lt;</span> <span class="no">Kosmonaut</span><span class="o">::</span><span class="no">Worker</span>
  <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">event</span> <span class="o">==</span> <span class="s2">"append_chat_history"</span>
      <span class="vi">@room</span> <span class="o">=</span> <span class="no">Room</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="ss">:room_id</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@room</span><span class="o">.</span><span class="n">messages</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">data</span><span class="o">[</span><span class="ss">:message</span><span class="o">]</span><span class="p">)</span>
      <span class="vi">@room</span><span class="o">.</span><span class="n">save!</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"WEBROCKET ERROR: </span><span class="si">#{</span><span class="n">err</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">on_exception</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
    <span class="nb">puts</span> <span class="s2">"INTERNAL ERROR: </span><span class="si">#{</span><span class="n">err</span><span class="o">.</span><span class="n">to_s</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>

<h4 id="Handlers">Handlers</h4>

<p><strong>on_message</strong> hanldles all valid incoming messages. It gets two arguments, first is an
event name, second - data hash associated to this event. Errors raised from within this
method are caught and handled by <code>on_exception</code> handler.</p>

<p><strong>on_error</strong> handles WebRocket protocol errors. If something will go wrong
with the communication between worker and WebRocket's backend, then appropriate
error object will be passed to this method. The same as with <code>on_message</code>, all
exceptions raised from within this method are caught and handled by <code>on_exception</code>
handler.</p>

<p><strong>on_exception</strong> handles internal errors. All exceptions raised from within
other handlers are caught and passed to this method.</p>

<h4 id="Starting+listener">Starting listener</h4>

<p>To make your worker running, you have to use <code>listen</code> method:</p>

<pre><code class="language-ruby"><span class="n">worker</span> <span class="o">=</span> <span class="no">MyWorker</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">"wr://token...@127.0.0.1:8080/vhost"</span><span class="p">)</span>
<span class="n">worker</span><span class="o">.</span><span class="n">listen</span></code></pre>

<p>Calling <code>listen</code> will block current thread. Worker automatically handles reconnects
and recovery from the errors. The only two cases when worker can break are when
specified token is invalid and <code>UnauthorizedError</code> appears, or when <code>on_exception</code>
callback raises an error.</p>

<h4 id="Listener+in+separate+thread">Listener in separate thread</h4>

<p>Kosmonaut is threadsafe, so worker can be run safely in separate thread:</p>

<pre><code class="language-ruby"><span class="no">Thread</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="n">worker</span><span class="o">.</span><span class="n">listen</span> <span class="p">}</span></code></pre>

<p>In this case you can stop the listener whenever you want from other thread using
<code>stop</code> method:</p>

<pre><code class="language-ruby"><span class="n">worker</span><span class="o">.</span><span class="n">stop</span></code></pre>

<h3 id="Troubleshooting">Troubleshooting</h3>

<p>If you encountered any problem while using Kosmonaut for Ruby, please let us not about it
by creating an <a href="http://github.com/webrocket/kosmonaut-ruby/issues">issue on github</a>.</p>

        </div>
        
      </div>
    </section>
    <footer role="contentinfo">
      <div class="vessel">
        <p id="copy">
          Copyleft 2011 - 2012 by
          <a href="http://www.nu7hat.ch/" title="That asshole with a weird hairdo :)">nu7</a>
          and folks at <a href="http://cuboxlabs.com" title="Awesome Dev Shop!">Cubox</a>.
        </p>
        <p id="footnote">
          <small>
            Some rights reserved. It's Open Source my friend! You can fork it <a href="http://github.com/webrocket/webrocket-website/">on github</a>.<br />
            This side has been built using <a href="http://nanoc.stoneship.org/">nanoc publishing system</a>.
          </small>
        </p>
      </div>
    </footer>
  </body>
</html>
